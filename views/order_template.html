<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Management</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="shortcut icon" href="https://icon-library.com/images/full-battery-icon/full-battery-icon-7.jpg">
    <style>
        body {
            background-color: #212121;
            color: white;
        }

        .navbar {
            background-color: #171717;
        }

        .navbar-nav .nav-link {
            color: white !important;
        }

        .navbar-brand {
            color: white !important;
        }

        .card {
            background-color: #333;
            color: white;
            margin-bottom: 20px;
        }

        .table {
            background-color: #333;
            color: white;
        }

        .modal-content {
            background-color: #fff;
            color: #000;
        }

        #progressBarContainer {
            display: none;
        }

        .progress-bar span {
            position: absolute;
            width: 100%;
            color: black;
            text-align: center;
            font-weight: bold;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light">
    <a class="navbar-brand" href="#">ERP System</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
            <li class="nav-item active">
                <a class="nav-link" href="/dashboard/{{ username }}">Home <span class="sr-only">(current)</span></a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/aboutUs/{{ username }}">About Us</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/contactUs/{{ username }}">Contact Us</a>
            </li>
        </ul>
        <ul class="navbar-nav ml-auto d-flex align-items-center">
            <!-- Avatar -->
            <div class="dropdown">
                <a
                        data-toggle="dropdown"
                        class="dropdown-toggle d-flex align-items-center hidden-arrow"
                        href="#"
                        id="navbarDropdownMenuAvatar"
                        role="button"
                        aria-expanded="false"
                >
                    {% if user.profile_pic_url %}
                    <img
                            src="{{ user.profile_pic_url }}"
                            class="rounded-circle"
                            height="25"
                            alt="User Avatar"
                            loading="lazy"
                    />
                    {% else %}
                    <img src="https://cdn-icons-png.freepik.com/512/266/266033.png" class="rounded-circle"
                            height="25"
                            alt="User Avatar"
                            loading="lazy">
                    {% endif %}
                </a>
                <ul class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownMenuAvatar">
                    <li><a class="dropdown-item" href="/profile/{{ username }}">My profile</a></li>
                    <li><a class="dropdown-item" href="/logout?username={{ username }}">Logout</a></li>
                </ul>
            </div>
        </ul>
    </div>
</nav>

<div class="container mt-5">
    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Place an Order</h5>
            <form id="orderForm">
                <div class="form-group">
                    <label for="battery_id">Battery Id</label>
                    <input type="text" class="form-control" id="battery_id" required>
                </div>
                <div class="form-group">
                    <label for="supplier_id">Supplier Id</label>
                    <input type="number" class="form-control" id="supplier_id" required>
                </div>
                <div class="form-group">
                    <label for="order_date">Date Order</label>
                    <input type="date" class="form-control" id="order_date" required>
                </div>
                <div class="form-group">
                    <label for="delivery_date">Date Delivery</label>
                    <input type="date" class="form-control" id="delivery_date" required>
                </div>
                <div class="form-group">
                    <label for="status">Status</label>
                    <input type="text" class="form-control" id="status" required>
                </div>
                <button type="button" class="btn btn-primary" onclick="placeOrder()">Place Order</button>
            </form>
        </div>
    </div>

    <div class="card mt-5" id="orders">
        <div class="card-body">
            <h5 class="card-title">Order List</h5>
            <table class="table table-dark table-striped">
                <thead>
                <tr>
                    <th scope="col">Order ID</th>
                    <th scope="col">Battery ID</th>
                    <th scope="col">Supplier</th>
                    <th scope="col">Date Of Order</th>
                    <th scope="col">Date Of Delivery</th>
                    <th scope="col">Status</th>
                    <th scope="col">Actions</th>
                </tr>
                </thead>
                <tbody id="orderList">
                {% for order in orders %}
                <tr>
                    <td>{{ order.order_id }}</td>
                    <td>{{ order.battery_id }}</td>
                    <td>{{ order.supplier_id }}</td>
                    <td>{{ order.order_date }}</td>
                    <td>{{ order.delivery_date }}</td>
                    <td>{{ order.status }}</td>
                    <td>
                        <button class="btn btn-primary" data-toggle="modal" data-target="#updateOrderModal"
                                onclick="showUpdateModal('{{ order.order_id }}', '{{ order.status }}')">Update
                        </button>
                        <button class="btn btn-warning" data-toggle="modal" data-target="#trackOrderModal"
                                onclick="showTrackModal('{{ order.order_id }}', '{{ order.status }}')">Track
                        </button>
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="updateOrderModal" tabindex="-1" role="dialog" aria-labelledby="updateOrderModalLabel"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updateOrderModalLabel">Update Order Status</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="updateOrderForm">
                    <input type="hidden" id="updateOrderId">
                    <div class="form-group">
                        <label for="orderStatus">New Status</label>
                        <input type="text" class="form-control" id="orderStatus">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="updateOrderStatus()">Save changes</button>
            </div>
        </div>
    </div>
</div>
<!-- Track Order Modal -->
<div class="modal fade" id="trackOrderModal" tabindex="-1" role="dialog" aria-labelledby="trackOrderModalLabel"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="trackOrderModalLabel">Track Order</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p><strong>Order ID:</strong> <span id="trackOrderId"></span></p>
                <p><strong>Status:</strong> <span id="trackOrderStatus"></span></p>
                <div>
                    <p><strong>Estimated Delivery:</strong></p>
                    <button type="button" class="btn btn-primary" id="reminderButton" onclick="trackOrder()">Reminder
                    </button>
                    <div id="progressBarContainer" class="mt-2">
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" style="width: 0%;" id="progressBar"
                                 aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                <span id="progressText">0%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
    function showUpdateModal(orderId, currentStatus) {
        document.getElementById('updateOrderId').value = orderId;
        document.getElementById('orderStatus').value = currentStatus;
    }

    function updateOrderStatus() {
        const orderId = document.getElementById('updateOrderId').value;
        const newStatus = document.getElementById('orderStatus').value;

        $.ajax({
            url: '/update_order_status',  // Update with the correct endpoint URL
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({order_id: orderId, status: newStatus}),
            success: function (response) {
                // Handle success response
                alert('Order status updated successfully');
                location.reload();  // Reload the page to see the changes
            },
            error: function (xhr, status, error) {
                // Handle error response
                console.error('Error updating order status:', status, error);
                alert('Failed to update order status');
            }
        });
    }

    function showTrackModal(orderId, currentStatus) {
        document.getElementById('trackOrderId').textContent = orderId;
        document.getElementById('trackOrderStatus').textContent = currentStatus;
        console.log('track order id ', orderId);
        console.log('track status id ', currentStatus);
    }

    function trackOrder() {
        // Hide the button
        document.getElementById('reminderButton').style.display = 'none';
        // Show the progress bar container
        document.getElementById('progressBarContainer').style.display = 'block';
        const orderId = document.getElementById('trackOrderId').innerHTML;
        const newStatus = document.getElementById('trackOrderStatus').innerHTML;
        console.log('order id = ', orderId);
        console.log('status  = ', newStatus);

        $.ajax({
            url: '/track_order',  // Update with the correct endpoint URL
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({order_id: orderId, status: newStatus}),
            success: function (response) {
                // Handle success response
                console.log(response.date)
                alert('Order status tracked successfully');
                // Animate the progress bar
                let progressBar = document.getElementById('progressBar');
                let width = 0;
                let interval = setInterval(function () {
                    if (width >= 100) {
                        clearInterval(interval);
                        // You can add additional actions here once the progress bar is complete
                    } else {
                        width = response.date;
                        progressBar.style.width = width + '%';
                        progressBar.setAttribute('aria-valuenow', width);
                        progressText.textContent = width + '%';
                    }
                }, 100); // Adjust the interval speed as needed
                // location.reload();  // Reload the page to see the changes
            },
            error: function (xhr, status, error) {
                // Handle error response
                console.error('Error tracked order :', status, error);
                alert('Failed to tracked order ');
            }
        });
    }

    function placeOrder() {
        // event.preventDefault(); // Prevent form from submitting normally

        const battery_id = document.getElementById('battery_id').value;
        const supplier_id = document.getElementById('supplier_id').value;
        const order_date = document.getElementById('order_date').value;
        const delivery_date = document.getElementById('delivery_date').value;
        const OrderStatus = document.getElementById('status').value;

        // Validate date inputs
        const orderDate = new Date(document.getElementById('order_date').value);
        const deliveryDate = new Date(document.getElementById('delivery_date').value);

        if (orderDate > deliveryDate) {
            alert('Delivery date must be after the order date.');
            return;
        }

        // Collect form data
        // const orderData = ;
        // console.log(orderData)

        // Send the order data to the server
        $.ajax({
            url: '/order',  // Update with the correct endpoint URL
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(
                {
                    battery_id:battery_id,
                    supplier_id:supplier_id,
                    order_date:order_date,
                    delivery_date:delivery_date,
                    OrderStatus:OrderStatus
                }
            ),
            success: function (response) {
                // Handle success response
                console.log(response.date)
                alert('add order successfully');
                location.reload();  // Reload the page to see the changes
            },
            error: function (xhr, status, error) {
                // Handle error response
                console.error('Error adding order :', error);
                alert('Failed to adding order ');
            }
        })
    }


</script>
</body>
</html>
